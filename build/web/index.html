<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PuppetStudio</title>
  <style>
    body { margin:0; overflow:hidden; background:#282828; }
    canvas { display:block; }
  </style>
</head>
<body>
  <div id="loader" style="
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:#282828;
    color:#fff;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    font-family:sans-serif;
    font-size:1.2em;
    z-index:9999;">
    <div id="loaderText">Loading...</div>
    <div style="width:200px;height:8px;background:#444;margin-top:10px;">
      <div id="loaderBar" style="width:0%;height:100%;background:#1abc9c;"></div>
    </div>
  </div>

  <canvas id="canvas"></canvas>
  <input id="folderInput" type="file" webkitdirectory hidden>
  <input id="fileInput" type="file" multiple hidden>
  <a id="tutorial" href="https://youtu.be/gmVuYbRK1vo" target="_blank" hidden></a>

  <script> /* <== Import Files ============================================> */
    
    let importRoute;
    function ImportFolder(route){
      importRoute = route;
      const input = document.getElementById("folderInput");
      input.value = "";
      input.click();
    }

    document.getElementById("folderInput").addEventListener("change", async (e) => {
      for (const file of e.target.files) {
        const relPath = file.webkitRelativePath || file.name;
        const fullPath = importRoute + "/" + relPath;
        const dir = fullPath.substring(0, fullPath.lastIndexOf("/"));
        FS.mkdirTree(dir);
        const buf = new Uint8Array(await file.arrayBuffer());
        FS.writeFile(fullPath, buf);
      }

      const rootFolderName = e.target.files[0].webkitRelativePath.split("/")[0];
      Module.ccall("PushLogSimple", null, ["string"], [`Succesfully imported '${rootFolderName}' into '${importRoute}'`]);
    });

    function ImportFIles(route){
      importRoute = route;
      const input = document.getElementById("fileInput");
      input.value = "";
      input.click();
    }

    document.getElementById("fileInput").addEventListener("change", async (e) => {
      for (const file of e.target.files) {
        console.log(file.name)
        const fullPath = importRoute + "/" + file.name;
        const buf = new Uint8Array(await file.arrayBuffer());
        FS.writeFile(fullPath, buf);
        Module.ccall("PushLogSimple", null, ["string"], [`Succesfully imported '${file.name}' into '${importRoute}'`]);
      }
    });
  </script>

  <script> /* <== Export Files ============================================> */
    
    function ExportFile(src, filename){
      const data = FS.readFile(src);
      const blob = new Blob([data]);
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = filename || src.split("/").pop();
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    
    function ExportDir(src, zipName) {
      const files = {};

      function walk(src, prefix="") {
        const entries = FS.readdir(src).filter(e => e !== "." && e !== "..");
        for (const entry of entries) {
          const fullPath = src + "/" + entry;
          const stat = FS.stat(fullPath);
          const isDir = (stat.mode & 0o170000) === 0o40000;
          if (isDir) walk(fullPath, prefix + entry + "/");
          else files[prefix + entry] = FS.readFile(fullPath);
        }
      }

      walk(src);

      const zipped = fflate.zipSync(files);
      const blob = new Blob([zipped], { type: "application/zip" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = zipName+".zip" || "export.zip";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

  </script>

  <script> /* <== Open Tutorial ===========================================> */
    function OpenTutorial(){
      document.getElementById('tutorial').click();
    }
  </script>

  <script> /* <== Load WASM ===============================================> */
    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loaderText');
    const loaderBar = document.getElementById('loaderBar');

    document.addEventListener("contextmenu", (e) => {
      e.preventDefault();
    });

    window.Module = {
      canvas: document.getElementById('canvas'),
      onRuntimeInitialized: function() {
        if (loader) loader.style.display = 'none';
      }
    };

    fetch('index.wasm')
      .then(response => {
        const total = parseInt(response.headers.get("Content-Length")) || 0;
        let loaded = 0;
        const reader = response.body.getReader();
        const chunks = [];

        function read() {
          return reader.read().then(({done, value}) => {
            if (done) return new Uint8Array(chunks.reduce((arr, v) => arr.concat(Array.from(v)), []));
            chunks.push(value);
            loaded += value.length;
            if (loaderText && total) loaderText.textContent = `Loading... ${Math.round((loaded/total)*100)}%`;
            if (loaderBar && total) loaderBar.style.width = `${Math.round((loaded/total)*100)}%`;
            return read();
          });
        }

        return read();
      })
      .then(bytes => {
        window.Module.wasmBinary = bytes;

        const script = document.createElement('script');
        script.src = 'index.js';
        script.onload = () => console.log("index.js loaded successfully");
        document.body.appendChild(script);
      })
      .catch(err => {
        if (loaderText) loaderText.textContent = 'Failed to load WASM';
        console.error(err);
      });
  </script>

  <script src="fflate_min.js"></script>
</body>
</html>

